<%- include('../layout/adminlayout.ejs') -%>
  <div class="container-scroller">

    <%- include('../layout/adminnav.ejs') -%>

      <div class="main-panel ">
        <div class="content-wrapper  d-flex flex-column  align-items-center">
          <div class=" gg d-flex align-items-center  justify-content-center "
            style="width: 100%; margin-top: -2rem; height: 100%; backdrop-filter: blur(2px); opacity: 0;  background-color: rgb(0 0 0 / 70%); position:absolute; ">
            <div class="col-lg-3 grid-margin edit-product-card">
              <div class="card edit" style=" border-radius: 15px;
              ">
                <form id="myForm1" method="post" enctype="multipart/form-data">
                  <div class="card-body edit-page">
                    <div class="d-flex flex-column align-items-center w-100 justify-content-center ">
                      <h3 class="text-center  text-white text-uppercase ">Edit Product</h3>
                      <div class="lin w-75 " style=" height: 1px; background-color: rgba(119, 119, 119, 0.363)"></div>
                    </div>
                    <br>
                    <div class="row img-row d-flex align-items-center justify-content-center gap-2 w-100 "
                      style="gap: 1rem;">

                      <div
                        class="imcircle d-flex align-items-center justify-content-center  overflow-hidden position-relative  "
                        style="width: 4.5rem; height: 4.5rem;   border-radius: 50%;  ">

                        <label for="image" id="imageL"
                          class="w-100   position-absolute fs-3 mt-1 d-flex align-items-center justify-content-center      pointer-event "
                          style="    background-color: rgb(24 23 23 / 11%);
                       backdrop-filter: blur(2px);
                       height: 5rem;
                       transition: all ease 0.3s;
                       cursor: pointer;
                       
                       ">
                          Edit
                        </label>
                        <input type="file" id="image" accept="image/jpeg, image/png, image/jpg" name="images"
                          style="display: none;" value="">
                        <img class="w-100 h-100  " style="object-fit: cover;"
                          src="/productImage/1705419439038 - ec70ef4be1a9d2ddf1ba1cfaabdb3e2f.jpg" alt="">

                      </div>

                    </div>
                    <br>
                    <div class="form-group">
                      <label for="exampleInputName1">Name</label>
                      <div class="dname">
                        <input type="text" class="text name form-control text-white " style="letter-spacing: 1px;"
                          name="name" style="color:white;" id="exampleInputName1" value="" placeholder="Name" required>
                        <p id="err1" class="text-danger "></p>
                      </div>
                    </div>

                    <div class=" w-100  d-flex align-items-center justify-content-center "
                      style="display: flex; gap:.5rem;">
                      <div class="form-group">
                        <label for="exampleInputPassword4">Price</label>
                        <div class="input-group mb-2 mr-sm-2">

                          <div class="input-group-prepend">
                            <div class="input-group-text">$</div>
                          </div>
                          <input type="number" class="form-control price" min="0" name="price"
                            style="letter-spacing: 1px;" id="price inlineFormInputGroupUsername2" placeholder="Price">
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="exampleInputPassword4">Stock</label>
                        <div class="input-group mb-2 mr-sm-2">


                          <input type="number" class="form-control stock" min="0" name="stock"
                            style="letter-spacing: 1px;" id=" stock inlineFormInputGroupUsername2" placeholder="Price">
                        </div>
                      </div>
                    </div>
                    <div class=" w-100  d-flex align-items-center justify-content-center "
                      style="display: flex; gap:.5rem;">
                      <div class="form-group" style="    width: 18rem;">

                        <label for="exampleSelectGender">Category</label>
                        <div class="input-group mb-2 mr-sm-2">
                          <select class="form-control text-white flex-grow-1 category" name="category"
                            style="letter-spacing: 1px; width: 100%;  color:white;" id="exampleSelectGender" required>
                            <% locals.ca.forEach(e=>{ %>
                              <option>
                                <%=e.name %>
                              </option>

                              <% }) %>

                          </select>
                        </div>
                      </div>
                    </div>
                    <div class="row w-100 d-flex align-items-center justify-content-center gap-3 " style="gap:1rem">
                      <button type="submit" class="btn bg-primary text-white border-0 "
                        style="letter-spacing: 1px;">submit</button>
                      <button type="button" onclick="backDash()" style="letter-spacing: 1px; background-color: #777;"
                        class="btn  text-white border-0 ">cancel</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="row hh">
            <div class="circle position-absolute " style="background-color: rebeccapurple;
            filter: blur(136px);
            width: 13rem;
            height: 10rem;
            border-radius: 50%;
            transform: translate(57rem, 23rem);"></div>
            <div class="circle position-absolute " style="background-color: rgba(0, 0, 255, 0.589);
            filter: blur(136px);
            width: 13rem;
            height: 10rem;
            border-radius: 50%;
         "></div>
            <div class="col-12 grid-margin">
              <div class="card " style="height: 80vh; border-radius: 15px; box-shadow: 0 0 0 0; border: 0;">
                <div class="card" style="border-radius: 15px; box-shadow: 0 0 0 0; border: 0;">
                  <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between ">
                      <h4 class="card-title">products</h4>
                      <a href="/admin/productAdd" class="btn btn-primary text-white "
                        style="outline: 0; border:0; margin-top: -1rem;">Add product</a>
                    </div>

                    </p>

                    <div class="table-responsive">
                      <table class="table">
                        <thead>
                          <tr>
                            <th> no </th>
                            <th> Name </th>
                            <th> image </th>
                            <th> Stock </th>
                            <th> price </th>
                            <th> Date </th>
                            <th> Cetegory </th>
                            <th> Active </th>
                            <th> options </th>
                          </tr>
                        </thead>
                        <tbody>
                          <% product.forEach((e,i)=>{ %>

                            <tr class="tr" id="e<%=e._id  %>" style="background-color: transparent !important;">
                              <td class="py-1">
                                <%= i+1 %>
                              </td>
                              <td>
                                <%= e.name %>
                              </td>
                              <td>

                                <div class="progress d-flex align-items-center  h-100 w-100  "
                                  style=" background-color: transparent; ">
                                  <%e.images.forEach(im=>{%>
                                    <div class="cir "
                                      style="display: inline-block; width: 30px; height: 30px;  border-radius: 50%; overflow: hidden;">
                                      <img style="width: 100%; height: 100%; object-fit: cover; "
                                        src='/productImage/<%=im %>' alt="">
                                    </div>

                                    <% }) %>
                                </div>
                              </td>
                              <td>
                                <%=e.stock %>
                              </td>
                              <td>
                                $<%=e.price %>
                              </td>
                              <td>
                                <%=e.createdAt %>
                              </td>
                              <td>
                                <%=e.category.name %>
                              </td>
                              <td>
                                <div onclick="" style="cursor: pointer;" class="badge  badge-outline-success">
                                  <%=e.status %>
                                </div>
                              </td>
                              <!-- New -->
                              <td>
                                <div onclick="active('<%= e._id %>')" id="b<%=e._id  %>" style="cursor: pointer;"
                                  class="badge  <%= e.listed ? 'badge-outline-success' : 'badge-outline-danger' %>">
                                  <%= e.listed ? 'Listed' : 'Unlisted' %>
                                </div>
                              </td>
                              <!-- New -->

                              <td class=" dropdown"> <a href="#" id="profile-dropdown" data-toggle="dropdown"><i
                                    class="mdi mdi-dots-vertical"></i></a>
                                <div style="min-width: 5rem; padding: .9rem 0; height: max-content; "
                                  class="dropdown-menu dropdown-menu-right navbar-dropdown preview-list   overflow-hidden "
                                  aria-labelledby="profile-dropdown">
                                  <div
                                    class="edit d-flex flex-column gap-2  h-100 w-100 justify-content-center align-items-center ">
                                    <% let b=[]; locals.ca.forEach(e=>{ b.push(e.name) }) %>
                                      <p onclick="edit('<%=JSON.stringify(e.images)%>','<%= e._id%>','<%= e.name %>','<%=e.stock  %>','<%=e.price  %>','<%=e.category.name  %>')"
                                        class="fs-5 "
                                        style="cursor: pointer; line-height: 0; margin-bottom: 0; color:#6c7293;">
                                        edit&nbsp;<i class="ri-edit-line  "></i></p>
                                      <br>
                                      <div class="d "
                                        style="width: 100%; height: 1px; background-color: rgba(77, 75, 75, 0.5);">
                                      </div>
                                      <br>
                                      <a href="#"  onclick="deleteProduct('<%= e._id %>')" class="fs-5 "
                                        style="line-height: 0; margin-bottom: 0; color:#6c7293;">
                                        dlt&nbsp;<i class="ri-delete-bin-3-line  "></i></a>
                                  </div>


                              </td>
                            </tr>
                            <% }) %>

                        </tbody>
                      </table>

                    </div>

                    <%- include('../layout/pagination.ejs') -%>

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
  </div>
  </div>


  <script>
    function deleteProduct(proId) {
        // Display a confirmation dialog before proceeding
        if (confirm('Are you sure you want to remove this product?')) {
            // Send an AJAX request to delete the user
            fetch('/admin/dltProduct?id=' + proId, {
                method: 'GET',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show a success toaster message or any other feedback
                    alert('Product removed successfully');
                    // Reload the page or update the UI as needed
                    location.reload();
                } else {
                    // Show an error toaster message or any other feedback
                    alert('Failed to remove product: ' + data.message);
                }
            })
            .catch(error => console.error('Error removing product:', error));
        }
    }
</script>

<script>
    function active(id) {

    const status = document.getElementById(`status${id}`)
    const btn = document.getElementById(`b${id}`)


    fetch('/admin/listedOrnot', {
      method: 'POST',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ payload: id})

    }).then(res => res.json()).then(data => {
      console.log("listed:"+data.updatedData.listed)
  
        // status.textContent=data.updatedData.listed

        console.log("listedOrnot: "+data.updatedData);
      
        if(data.updatedData.listed===false){
   
          btn.style.borderColor='#d72624'
          btn.style.color='#d72624'
          btn.textContent="Unlisted"    
        }else{
           
          btn.style.borderColor='#00b032'
          btn.style.color='#00b032'                 
          btn.textContent="Listed"
        }
        
        

    })
    }
  </script>

  <script>
    const imageRow = document.querySelector('.img-row');
    const name1 = document.querySelector('.name');
    const price1 = document.querySelector('.price');
    const stock1 = document.querySelector('.stock');
    const catName1 = document.querySelector('.category');
    const gg = document.querySelector('.gg');
    const dname = document.querySelector('.dname');
    function removeP(i,im) {

      const pi = document.getElementById(`p${i}`);
      const myForm = document.getElementById('myForm1');
      const hiddenInput = document.createElement('input');
      const Input = document.createElement('input');
      Input.type = 'hidden';
      Input.name = `pe${i}`;
      Input.value = 'true';
      hiddenInput.type = 'hidden';
      hiddenInput.name = `pe`;
      hiddenInput.value = im;
      myForm.appendChild(hiddenInput);
      myForm.appendChild(Input);

      pi.remove()
    }

    function edit(image, id, name, stock, price, catName) {
      let myForm = document.getElementById('myForm1');
      myForm.action = `/admin/edit?id=${id}`;
      const im = JSON.parse(image)
      name1.value = name
      price1.value = price
      stock1.value = stock
      catName1.value = catName
      imageRow.innerHTML = `${im.map((im, i) => `     <div class="d-flex flex-column " id='p${i}'>
                          <div
                        class="imcircle d-flex align-items-center justify-content-center  overflow-hidden position-relative  "
                        style="width: 4.5rem; height: 4.5rem;   border-radius: 50%;  ">
                        <label for="image${i}"    id="imageL"
                          class="w-100   position-absolute fs-3 mt-1 d-flex align-items-center justify-content-center      pointer-event "
                          style="    background-color: rgb(24 23 23 / 11%);
                       backdrop-filter: blur(2px);
                       height: 5rem;
                       transition: all ease 0.3s;
                       cursor: pointer;
                       
                       ">
                          Edit
                        </label>
                        <input type="file" class='file' data-index='${i}' id="image${i}" accept="image/jpeg, image/png, image/jpg" name="images${i}"
                          style="display: none;" value='${im}'>
                        <img class="w-100 h-100 " id='im${i}' style="object-fit: cover;"
                          src="/productImage/${im}" alt="">
                          </div>
                          
                        <div id='d${i}'></div>
                          <p style='cursor: pointer;'  onclick="removeP('${i}','${im}')" class='mt-1 text-white  '>remove</p>
                        </div>
                      `).join('')}`;

      gg.style.opacity = 1;
      gg.style.zIndex = 9;
      for (let i = 0; i < 3; i++) {
        document.getElementById(`image${i}`).addEventListener('click', () => {
          filee(i)
        })
      }

    }

    function filee(i) {
  let file = document.getElementById(`image${i}`);
  file.onchange = () => {
    let img = document.getElementById(`im${i}`);
    let uploadedFile = file.files[0];
    if (uploadedFile) {
      if (['image/png', 'image/jpeg', 'image/jpg'].includes(uploadedFile.type)) {
        img.src = URL.createObjectURL(uploadedFile);
      } else {
        alert("Please upload only PNG, JPEG, or JPG files.");
        file.value = null;
      }
    }
  };
}



    function backDash() {
      gg.style.opacity = 0;
      gg.style.zIndex = -2;

    }

  </script>
  <script src="/vendors/js/vendor.bundle.base.js"></script>

  <script src="/vendors/chart.js/Chart.min.js"></script>
  <script src="/vendors/progressbar.js/progressbar.min.js"></script>
  <script src="/vendors/jvectormap/jquery-jvectormap.min.js"></script>
  <script src="/vendors/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
  <script src="/vendors/owl-carousel-2/owl.carousel.min.js"></script>

  <script src="/js/off-canvas.js"></script>
  <script src="/js/hoverable-collapse.js"></script>
  <script src="/js/misc.js"></script>
  <script src="/js/settings.js"></script>
  <script src="/js/todolist.js"></script>
  <script src="/js/dashboard.js"></script>
  <style>
    @font-face {
      font-family: req;
      src: url(/fonts/611aee5b70cc88187b78993c_GRIFTER.otf);
    }

    @media (max-width:900px) {
      .hh {
        width: 90vw;
      }
      .edit-product-card {
        max-width: 30% !important;
      }

    }

    @media (min-width:900px) {
      
      .edit-product-card {
        max-width: 30% !important;
      }

    }

    .gg {
      opacity: 0;

      z-index: -2;
      transition: all ease 0.7s;
    }

    #imageL {
      opacity: 0;
    }

    .imcircle:hover #imageL {
      opacity: 1;
    }

    body::-webkit-scrollbar {
      width: 0;
    }

    body {
      overflow: hidden !important;
    }

    .container-scroller {
      overflow: hidden;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none !important;
    }

    .edit-page {
      font-family: req;
      letter-spacing: 2px;
    }

    h3 {
      margin-top: -1rem;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/locomotive-scroll@3.5.4/dist/locomotive-scroll.js"></script>

  <script src="https://unpkg.com/@studio-freight/lenis@1.0.33/dist/lenis.min.js"></script>

  <script src="/js/base.js"></script>

  </body>

  </html>